# server {
#     listen 80;
#     index index.html;
#     server_tokens off;
#     client_max_body_size 50M;
    
#     # Глобальное сжатие для всех ответов
#     gzip on;
#     gzip_vary on;
#     gzip_min_length 1024;
#     gzip_comp_level 6;
#     gzip_types 
#         text/plain
#         text/css
#         text/xml
#         text/javascript
#         application/json
#         application/javascript
#         application/xml+rss
#         application/atom+xml
#         image/svg+xml;
    
#     # Безопасность заголовков
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
#     add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
#     # Ограничение типов файлов для загрузки
#     location ~ /\. {
#         deny all;
#         access_log off;
#         log_not_found off;
#     }

#     # Кеширование статики
#     location /static/ {
#         alias /backend_static/;
#         expires 7d;
#         add_header Cache-Control "public, immutable";
#         add_header Vary "Accept-Encoding";
#         access_log off;
        
#         # Безопасность: запрет исполнения скриптов
#         location ~* \.(php|py|pl|sh|cgi)$ {
#             deny all;
#         }
        
#         # Оптимизация для статических файлов
#         location ~* \.(css|js)$ {
#             add_header Cache-Control "public, immutable, max-age=604800";
#             expires 7d;
#         }
#     }

#     # Кеширование шрифтов и иконок из статики
#     location ~* /static/.*\.(woff|woff2|ttf|eot|otf|ico|svg)$ {
#         alias /backend_static/;
#         expires 90d;  # Долгое кеширование для шрифтов
#         add_header Cache-Control "public, immutable, max-age=7776000";  # 90 дней
#         add_header Vary "Accept-Encoding";
#         access_log off;
        
#         # Безопасность шрифтов
#         add_header X-Content-Type-Options "nosniff";
#         add_header X-Frame-Options "SAMEORIGIN";
#         try_files $uri =404;
#     }

#     # Кеширование изображений из основной статики (img folder)
#     location ~* /static/img/.*\.(jpg|jpeg|png|gif|webp|bmp|tiff|ico|svg)$ {
#         alias /backend_static/;
#         expires 60d;  # Долгое кеширование для статических изображений
#         add_header Cache-Control "public, immutable, max-age=5184000";  # 60 дней
#         add_header Vary "Accept-Encoding";
#         access_log off;
        
#         # Безопасность изображений
#         add_header X-Content-Type-Options "nosniff";
#         add_header X-Frame-Options "SAMEORIGIN";
#         try_files $uri =404;
#     }

#     # Кеширование для /media/ (публичные медиа-файлы загруженные админом)
#     location /static/media/ {
#         alias /backend_media/;
#         expires 30d;
#         add_header Cache-Control "public, max-age=2592000";  # 30 дней
#         add_header Vary "Accept-Encoding";
#         access_log off;
        
#         # Безопасность: разрешены только изображения и документы
#         location ~* \.(jpg|jpeg|png|gif|svg|webp|pdf|doc|docx)$ {
#             add_header X-Content-Type-Options "nosniff";
#             add_header X-Frame-Options "SAMEORIGIN";
#             try_files $uri =404;
#         }
        
#         # Запрет исполняемых файлов
#         location ~* \.(php|py|pl|sh|cgi|exe|bat|com|js|html)$ {
#             deny all;
#         }
#     }

#     # Кеширование для /user_images/ (пользовательские изображения)
#     location /static/user_images/ {
#         alias /backend_user_images/;
#         expires 7d;
#         add_header Cache-Control "public, max-age=604800";  # 7 дней
#         add_header Vary "Accept-Encoding";
#         access_log off;
        
#         # Строгие ограничения: только изображения
#         location ~* \.(jpg|jpeg|png|gif|webp)$ {
#             add_header X-Content-Type-Options "nosniff";
#             add_header X-Frame-Options "SAMEORIGIN";
#             # Дополнительная безопасность для пользовательского контента
#             add_header Content-Security-Policy "default-src 'none'; img-src 'self'";
#             add_header Referrer-Policy "strict-origin-when-cross-origin";
#             try_files $uri =404;
#         }
        
#         # Запрет всех остальных типов файлов
#         location ~* \..*$ {
#             deny all;
#             return 403;
#         }
#     }

#     # Прокси для backend
#     location / {
#         proxy_pass http://backend:5000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
        
#         # Таймауты
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
        
#         # Буферизация
#         proxy_buffering on;
#         proxy_buffer_size 4k;
#         proxy_buffers 8 4k;
        
#         # Безопасность
#         proxy_hide_header X-Powered-By;
#         proxy_set_header X-Forwarded-Host $host;
#         proxy_set_header X-Forwarded-Server $host;
#     }
# }
server {
    listen 80;
    index index.html;
    server_tokens off;
    client_max_body_size 50M;

    # Gzip
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Скрытые файлы
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Приглушаем .map (необязательно, но полезно)
    location ~* \.map$ {
        access_log off;
        log_not_found off;
        return 204;
    }

    # =========================
    #  /static/   (общая статика)
    # =========================
    # Общий префикс для статики (без ^~, чтобы regex ниже имели приоритет)
    location /static/ {
        alias /backend_static/;
        expires 7d;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";
        access_log off;
    }

    # CSS/JS со специфичным кэшем (захват + alias)
    location ~* ^/static/(.+\.(css|js))$ {
        alias /backend_static/$1;
        expires 7d;
        add_header Cache-Control "public, immutable, max-age=604800";
        add_header Vary "Accept-Encoding";
        access_log off;
    }

    # Шрифты (захват + alias; добавлен CORS на всякий случай)
    location ~* ^/static/(.+\.(woff2?|ttf|eot|otf|ico|svg))$ {
        alias /backend_static/$1;
        expires 90d;
        add_header Cache-Control "public, immutable, max-age=7776000";
        add_header X-Content-Type-Options "nosniff";
        add_header X-Frame-Options "SAMEORIGIN";
        add_header Access-Control-Allow-Origin "*" always;
        access_log off;
    }

    # (опционально) Картинки из /static/img/ с более длинным кэшем
    location ~* ^/static/img/(.+\.(jpg|jpeg|png|gif|webp|bmp|tiff|ico|svg))$ {
        alias /backend_static/img/$1;
        expires 60d;
        add_header Cache-Control "public, immutable, max-age=5184000";
        add_header Vary "Accept-Encoding";
        add_header X-Content-Type-Options "nosniff";
        add_header X-Frame-Options "SAMEORIGIN";
        access_log off;
    }

    # =========================
    #  /static/media/   (публичные медиа)
    # =========================
    # Базовый префикс
    location /static/media/ {
        alias /backend_media/;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        add_header Vary "Accept-Encoding";
        access_log off;
    }

    # Разрешённые типы (при желании ужесточить)
    location ~* ^/static/media/(.+\.(jpg|jpeg|png|gif|svg|webp|pdf|doc|docx))$ {
        alias /backend_media/$1;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        add_header X-Content-Type-Options "nosniff";
        add_header X-Frame-Options "SAMEORIGIN";
        access_log off;
    }

    # Запрет исполняемых/подозрительных в media
    location ~* ^/static/media/.+\.(php|py|pl|sh|cgi|exe|bat|com|js|html)$ {
        return 403;
    }

    # =========================
    #  /static/user_images/   (пользовательский контент)
    # =========================
    # Базовый префикс
    location /static/user_images/ {
        alias /backend_user_images/;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        add_header Vary "Accept-Encoding";
        access_log off;
    }

    # Только изображения + жёсткие заголовки
    location ~* ^/static/user_images/(.+\.(jpg|jpeg|png|gif|webp))$ {
        alias /backend_user_images/$1;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        add_header Content-Security-Policy "default-src 'none'; img-src 'self'";
        add_header Referrer-Policy "strict-origin-when-cross-origin";
        add_header X-Content-Type-Options "nosniff";
        add_header X-Frame-Options "SAMEORIGIN";
        access_log off;
    }

    # Остальное в user_images запрещаем
    location ~* ^/static/user_images/ {
        return 403;
    }

    # =========================
    #  Прокси на backend
    # =========================
    location / {
        proxy_pass http://backend:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;

        proxy_hide_header X-Powered-By;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
    }
}
